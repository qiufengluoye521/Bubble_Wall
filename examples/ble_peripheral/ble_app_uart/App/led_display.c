#include "led_display.h"
#include "nrf_gpio.h"
#include "app_timer.h"
#include "nrf_delay.h"


#define LED_CHANGE_TIMER_MS                         1000
#define APP_TIMER_PRESCALER                         0
#define TIMER_LED_CHANGE_INTERVAL                   APP_TIMER_TICKS(LED_CHANGE_TIMER_MS, APP_TIMER_PRESCALER) 

#define LED_CLOSE_LED_TIMER_MS                      400
#define TIMER_CLOSE_LED_INTERVAL                    APP_TIMER_TICKS(LED_CLOSE_LED_TIMER_MS, APP_TIMER_PRESCALER) 

APP_TIMER_DEF(m_led_frame_change_id);
APP_TIMER_DEF(m_close_led_id);


typedef struct
{
    const uint8_t * pic_frame;
    uint16_t offset;
} bubble_wall_pic_frame;

bubble_wall_pic_frame m_bubble_wall_pic_frame;

const uint8_t bubble_wall_pic[BUBBLE_WALL_PIC_LENGTH] =
{
    0x80,0x00,0x00,0x04,0x40,0x00,0x00,0x08,0x20,0x00,0x00,0x10,0x10,0x00,0x00,0x20,
    0x08,0x00,0x00,0x40,0x04,0x00,0x00,0x80,0x02,0x00,0x01,0x00,0x01,0x00,0x02,0x00,
    0x00,0x80,0x04,0x00,0x80,0x40,0x08,0x04,0x40,0x20,0x10,0x08,0x20,0x10,0x20,0x10,
    0x10,0x08,0x40,0x20,0x08,0x04,0x80,0x40,0x04,0x03,0x00,0x80,0x02,0x00,0x01,0x00,
    0x01,0x00,0x02,0x00,0x00,0x80,0x04,0x00,0x80,0x40,0x08,0x04,0x40,0x20,0x10,0x08,
    0x20,0x10,0x20,0x10,0x10,0x08,0x40,0x20,0x08,0x04,0x80,0x40,0x04,0x03,0x00,0x80,
    0x02,0x00,0x01,0x00,0x01,0x00,0x02,0x00,0x00,0x80,0x04,0x00,0x00,0x40,0x08,0x00,
    0x00,0x20,0x10,0x00,0x00,0x10,0x20,0x00,0x00,0x08,0x40,0x00,0x00,0x04,0x80,0x00,
    0x00,0x03,0x00,0x00,0x02,0x00,0x01,0x00,0x04,0x00,0x00,0x80,0x08,0x00,0x00,0x40,
    0x10,0x00,0x00,0x20,0x20,0x00,0x00,0x10,0x40,0x00,0x00,0x08,0x80,0x00,0x00,0x04,
    0x02,0x00,0x01,0x00,0x04,0x00,0x00,0x80,0x08,0x00,0x00,0x40,0x10,0x00,0x00,0x20,
    0x20,0x03,0x00,0x10,0x40,0x04,0x80,0x08,0x80,0x08,0x40,0x04,0x00,0x10,0x20,0x00,
    0x00,0x20,0x10,0x00,0x00,0x40,0x08,0x00,0x00,0x80,0x04,0x00,0x01,0x00,0x02,0x00,
    0x02,0x00,0x01,0x00,0x04,0x03,0x00,0x80,0x08,0x04,0x80,0x40,0x10,0x08,0x40,0x20,
    0x20,0x10,0x20,0x10,0x40,0x20,0x10,0x08,0x80,0x40,0x08,0x04,0x00,0x80,0x04,0x00,
    0x01,0x00,0x02,0x00,0x02,0x00,0x01,0x00,0x04,0x03,0x00,0x80,0x08,0x04,0x80,0x40,
    0x10,0x08,0x40,0x20,0x20,0x10,0x20,0x10,0x40,0x20,0x10,0x08,0x80,0x40,0x08,0x04,
    0x00,0x80,0x04,0x00,0x01,0x00,0x02,0x00,0x02,0x00,0x01,0x00,0x04,0x00,0x00,0x80,
    0x08,0x00,0x00,0x40,0x10,0x00,0x00,0x20,0x20,0x00,0x00,0x10,0x40,0x00,0x00,0x08,
    0x80,0x00,0x00,0x04,0x01,0x00,0x02,0x00,0x02,0x80,0x05,0x00,0x04,0x40,0x08,0x80,
    0x08,0x20,0x10,0x40,0x10,0x10,0x20,0x20,0x20,0x08,0x40,0x10,0x40,0x04,0x80,0x08,
    0x80,0x03,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x03,0x00,0x00,0x00,0x04,0x80,0x00,0x00,0x08,0x40,0x00,0x00,0x10,0x20,0x00,
    0x00,0x20,0x10,0x00,0x00,0x40,0x08,0x00,0x00,0x80,0x04,0x00,0x01,0x00,0x02,0x00,
    0x02,0x00,0x01,0x00,0x04,0x00,0x00,0x80,0x08,0x00,0x00,0x40,0x10,0x00,0x00,0x20,
    0x20,0x00,0x00,0x10,0x40,0x00,0x00,0x08,0x80,0x00,0x00,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x0F,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x03,0xF0,0x3F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0xFC,0x00,0x00,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xC0,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x80,0x01,0xF0,0x00,0x40,0x00,0x00,0x00,0x20,0x00,0x00,0x00,
    0x10,0x00,0x0F,0x80,0x08,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x02,0x00,0x00,0x7C,
    0x01,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x40,0x00,0x00,0x80,0x20,0x00,0x00,
    0x40,0x10,0x00,0x00,0x20,0x08,0x00,0x00,0x10,0x04,0x00,0x00,0x08,0x02,0x00,0x00,
    0x04,0x01,0x00,0x00,0x02,0x00,0x80,0x00,0x01,0x00,0x40,0x00,0x00,0x80,0x20,0x00,
    0x00,0x40,0x10,0x00,0x00,0x20,0x08,0x00,0x00,0x10,0x04,0x00,0x00,0x08,0x02,0x00,
    0x00,0x04,0x01,0x00,0x00,0x02,0x00,0x80,0x00,0x01,0x00,0x40,0x00,0x00,0x80,0x20,
    0x00,0x00,0x40,0x10,0x00,0x00,0x20,0x08,0x00,0x00,0x10,0x04,0x00,0x00,0x08,0x00,
    0x00,0x00,0x04,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x80,
    0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x08,
    0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00
};

uint8_t gpio_pin[8] = 
{
    GPIO_P9,GPIO_P10,GPIO_P11,GPIO_P12,GPIO_P13,GPIO_P14,GPIO_P15,GPIO_P16
};

uint8_t latch_pin[32] = 
{
    GPIO_A7,GPIO_A7,GPIO_A7,GPIO_A7,GPIO_A7,GPIO_A7,
    GPIO_A5,GPIO_A5,GPIO_A5,GPIO_A5,
    GPIO_A5,GPIO_A5,GPIO_A5,GPIO_A5,
    GPIO_A6,GPIO_A6,GPIO_A6,GPIO_A6,GPIO_A6,GPIO_A6,
    GPIO_A6,GPIO_A6,
    GPIO_A4,GPIO_A4,GPIO_A4,GPIO_A4,GPIO_A4,GPIO_A4,GPIO_A4,GPIO_A4,
    32,32
};


/* --------------------------------------------------------------------------
* static funtion
*/


/**
* @brief : turn_on_led
*
* @parain: i,j-> select led num to turn on
* @paraout: null
*
* @return:null
*/
static void turn_on_led(uint8_t dis_i,uint8_t dis_j)
{
    uint8_t display_num;
    
    display_num = (dis_i+1)*(dis_j+1);
    printf("display_num is:%d \r\n",display_num);
    
    
    // 关闭锁存端口
    nrf_gpio_pin_clear(GPIO_A4);
    nrf_gpio_pin_clear(GPIO_A5);
    nrf_gpio_pin_clear(GPIO_A6);
    nrf_gpio_pin_clear(GPIO_A7);
    
    // 开启指定脚led
    nrf_gpio_pin_set(gpio_pin[dis_j]);
//    nrf_delay_ms(10);
        
    // 开启指定脚的锁存端口
    nrf_gpio_pin_set(latch_pin[display_num-1]);
    if((display_num>=24) && (display_num<=30) )
    {
        printf("display_num is %d\r\n",display_num);
        printf("latch_pin[display_num-1] is %d\r\n",latch_pin[display_num-1]);
        printf("display_num is %d\r\n",display_num);
    }

    return;
}

/**
* @brief : turn_off_led
*
* @parain: i,j-> select led num to turn off
* @paraout: null
*
* @return:null
*/
static void turn_off_led(uint8_t dis_i,uint8_t dis_j)
{
    uint8_t display_num;
    
    display_num = (dis_i+1)*(dis_j+1);
    
    // 关闭锁存端口
    nrf_gpio_pin_clear(GPIO_A4);
    nrf_gpio_pin_clear(GPIO_A5);
    nrf_gpio_pin_clear(GPIO_A6);
    nrf_gpio_pin_clear(GPIO_A7);
    
    // 开启指定脚led
    nrf_gpio_pin_clear(gpio_pin[dis_j]);
//    nrf_delay_ms(10);
    
    // 开启指定脚的锁存端口
    nrf_gpio_pin_set(latch_pin[display_num-1]);

    return;
}


/**
* @brief : display one frame
*
* @parain: one frame data to display
* @paraout: null
*
* @return:null
*/
uint8_t temp1;
uint8_t temp2;
bool temp3;
static void display_one_frame(const uint8_t * data)
{
    uint8_t i;
    uint8_t j;
    for(i=0;i<4;i++)
    {
        for(j=8;j>0;j--)
        {
            temp1 = 1<<(j-1);
            temp2 = data[i] & temp1;
            temp3 = (temp2 != 0);
            if(temp3)
            {
                turn_on_led(i,j);
            } else
            {
                turn_off_led(i,j);
            }
        }
    }
}

/**
* @brief : timer for changing led on and off, change one frame in severial ms
*
* @parain: null
* @paraout: null
*
* @return:null
*/
static void Timer_change_frame_process(void * p_contex)
{
    uint32_t err_code  = 0;
    
    printf("Timer_change_frame_process ----> display one frame\r\n");
    
    m_bubble_wall_pic_frame.pic_frame   = &bubble_wall_pic[m_bubble_wall_pic_frame.offset];
    display_one_frame(m_bubble_wall_pic_frame.pic_frame);
    
    m_bubble_wall_pic_frame.offset      = m_bubble_wall_pic_frame.offset + 4;
    

    err_code = app_timer_start(m_close_led_id, TIMER_CLOSE_LED_INTERVAL, NULL);
    APP_ERROR_CHECK(err_code);
}

static void Timer_close_led_process(void * p_contex)
{
    uint8_t i;
    int8_t j;
    printf("Timer_close_led_process ----> turn off all led\r\n");

    for(i=0;i<4;i++)
    {
        for(j=7;j>=0;j--)
        {
            turn_off_led(i,j);
        }
    }
}

static void led_timer_init(void)
{
    uint32_t err_code  = 0;
    err_code = app_timer_create(&m_led_frame_change_id, APP_TIMER_MODE_REPEATED, Timer_change_frame_process);
    APP_ERROR_CHECK(err_code);    
    err_code = app_timer_create(&m_close_led_id, APP_TIMER_MODE_SINGLE_SHOT, Timer_close_led_process);
    APP_ERROR_CHECK(err_code);
    
    err_code = app_timer_start(m_led_frame_change_id, TIMER_LED_CHANGE_INTERVAL, NULL);
    APP_ERROR_CHECK(err_code);
    
    m_bubble_wall_pic_frame.offset = 0;
}


void led_init(void)
{
    uint8_t i;
    
    for(i=0;i<32;i++)
    {
        nrf_gpio_cfg_output(i);
        nrf_gpio_pin_clear(i);
    }
    
    
    
    led_timer_init();
    for(i=0;i<32;i++)
    {
        nrf_gpio_cfg_output(i);
        nrf_gpio_pin_set(i);
    }

}




